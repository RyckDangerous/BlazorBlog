@page "/articles/create"

@using BlazorBlog.Features.CreateArticle.Services
@using BlazorBlog.Features.CreateArticle.Components
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer

@attribute [Authorize]
@inject ICreateArticlePageViewService ViewService

<PageTitle>Cr√©er un article</PageTitle>

<div class="create-article-container">
    <div class="create-article-header">
        <h1 class="tech-title">
            <span class="tech-accent">></span> Cr√©er un nouvel article
        </h1>
        <p class="tech-subtitle">R√©digez votre article en Markdown</p>
    </div>

    <EditForm Model="@ViewService.InputModel" class="article-form">
        <DataAnnotationsValidator />
        
        <div class="form-group">
            <label for="title" class="form-label">
                <span class="label-icon">üìù</span> Titre
            </label>
            <InputText id="title" @bind-Value="ViewService.InputModel.Title" class="form-control tech-input" placeholder="Entrez le titre de votre article..." />
            <ValidationMessage For="@(() => ViewService.InputModel.Title)" class="validation-message" />
        </div>

        <div class="form-group">
            <label for="content" class="form-label">
                <span class="label-icon">üìÑ</span> Contenu (Markdown)
            </label>
            <MarkdownEditor Content="@ViewService.InputModel.Content" ContentChanged="@HandleContentChanged" />
            <ValidationMessage For="@(() => ViewService.InputModel.Content)" class="validation-message" />
        </div>

        @if (ViewService.ErrorMessage is not null)
        {
            <div class="alert alert-error">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <span>@ViewService.ErrorMessage</span>
            </div>
        }

        @if (ViewService.IsSubmitting)
        {
            <div class="submitting-overlay">
                <div class="spinner"></div>
                <p>Cr√©ation en cours...</p>
            </div>
        }

        <div class="form-actions">
            <button type="button" class="btn btn-primary tech-btn" @onclick="HandlePublish" @onclick:preventDefault="true" disabled="@ViewService.IsSubmitting">
                <span class="btn-icon">üöÄ</span>
                @if (ViewService.IsSubmitting)
                {
                    <span>Publication...</span>
                }
                else
                {
                    <span>Publier</span>
                }
            </button>
            <button type="button" class="btn btn-secondary tech-btn" @onclick="HandleSaveDraft" @onclick:preventDefault="true" disabled="@ViewService.IsSubmitting">
                <span class="btn-icon">üíæ</span>
                @if (ViewService.IsSubmitting)
                {
                    <span>Sauvegarde...</span>
                }
                else
                {
                    <span>Sauvegarder en brouillon</span>
                }
            </button>
            <button type="button" class="btn btn-tertiary tech-btn" @onclick="@ViewService.Cancel" @onclick:preventDefault="true" disabled="@ViewService.IsSubmitting">
                <span class="btn-icon">‚úñ</span> Annuler
            </button>
        </div>
    </EditForm>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewService.InitializeAsync();
    }

    private async Task HandlePublish()
    {
        // Valider le formulaire avant de publier
        if (string.IsNullOrWhiteSpace(ViewService.InputModel.Title) || string.IsNullOrWhiteSpace(ViewService.InputModel.Content))
        {
            return;
        }

        await ViewService.PublishAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleSaveDraft()
    {
        // Valider au moins le titre pour sauvegarder en brouillon
        if (string.IsNullOrWhiteSpace(ViewService.InputModel.Title))
        {
            return;
        }

        await ViewService.SaveAsDraftAsync();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task HandleContentChanged(string newContent)
    {
        ViewService.InputModel.Content = newContent;
        await InvokeAsync(StateHasChanged);
    }
}

